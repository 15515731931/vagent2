<!DOCTYPE html>
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <title>Varnish Agent</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Le styles -->
    <link href="/html/bootstrap/css/bootstrap.css" rel="stylesheet">
    <style type="text/css">
      body {
        padding-top: 60px;
        padding-bottom: 40px;
      }
      .sidebar-nav {
        padding: 9px 0;
      }

    </style>
    <link href="/html/bootstrap/css/bootstrap-responsive.css" rel="stylesheet">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

  <style type="text/css"></style></head>

  <body>
    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="http://varnish-software.com/">Varnish Agent</a>
          <div class="nav-collapse collapse">
            <ul class="nav">
              <li class="active" id="nav-home"><a href="#home" onclick="showHome()">Home</a></li>
	      <li id="nav-vcl"><a href="#VCL" onclick="showVCL()">VCL</a></li>
	      <li id="nav-param"><a href="#params" onclick="showParam()">Parameters</a></li>
	      <li><a href="/">Root</a></li>
            </ul>
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>

    <div class="container-fluid">
      <div class="row-fluid">
        <div class="span3">
          <div class="well sidebar-nav">
            <ul class="nav nav-list">
              <li class="nav-header">Status</li>
		<li><a onclick="stop()">Stop Varnish</a></li>
		<li><a onclick="start()">Start Varnish</a></li>
            </ul>
          </div><!--/.well -->
	  <button class="btn disabled btn-block btn-primary" id="vcl-btn"></button>
	  <button class="btn disabled btn-block btn-primary" id="stats-btn"></button>
	  <button class="btn disabled btn-block" id="status-btn"></button>
	  <pre id="out"></pre>
	  <p id="test-out"></p>
        </div><!--/span-->
	<div class="span9" id="vcl" style="DISPLAY: none">
	  <textarea id="vcl-text" class="input-block-level" rows=25></textarea>
	  <br>
          <div class="input-append">
	    <input class="span3" type=text placeholder="VCL id" id="vclID"></input>
		<button id="upbut" class="btn btn-primary" data-loading-text="Saving..." onclick="uploadVCL()">Save VCL</button>
	  </div>
	  <div class="input-append">
		<select id="loader" class="span3"></select>
		<button id="viewbut" type="button" class="btn btn-primary" data-loading-text="Loading..." onclick="loadVCL()">View VCL</button>
		<button class="btn" onclick="deployVCL()">Use VCL</button>
		<button class="btn" onclick="discardVCL()"><i class="icon-trash"></i> Discard VCL</button>
	  </div>
        </div>
	<div class="span9" id="params" style="DISPLAY: none">
	    <select onchange="paramChange()" id="param-sel"></select>
	    <div class="input-append">
	      <input type="text" id="param-val" placeholder="Parameter value"/>
	      <button type=submit class="btn btn-primary" onclick="saveParam()">Save parameter</button>
	      <button class="btn" onclick="setParamDef()">Set to default</button>
	      <button class="btn" onclick="paramListDiff()">View Diff</button>
	    </div>
	</div>
	<div class="span9" id="home">
          <div class="hero-unit">
	    <h1>Welcome to the Varnish Agent</h1>
	    <p>This is the Varnish Agent's HTML interface. It is designed
	    to showcase the various features of the Varnish Agent.</p>
	    <p>The Varnish Agent is a small daemon that runs on the same
	    machine as your <a href="http://varnish-cache.org">Varnish
	    Cache</a>. It gives you a simple REST interface to control the
	    behavior of Varnish, including most common administrative
	    tasks, such as changing VCL, reviewing and setting parameters,
	    stopping and starting the child and issuing bans (cache
	    invalidation).</p>
	    <p>The agent can be used stand alone through this web page, it
	    can be integrated into other site-specific systems, it can be
	    used in conjunction with the <a
	    href="http://varnish-software.com">Varnish Administration
	    Console</a> to control multiple Varnish caches, or a mix of
	    them all.</p>
	    <p>The agent strives to be "self documenting", meaning that the
	    REST API should be easily understood by browsing the root
	    directory. That is to say, browsing <a href="/">/</a>. The
	    content you are currently viewing is the asset-serving portion
	    of the agent, found under <a href="/html/">/html/</a>.
	    Typically installed to /usr/local/share/varnish-agent/html or
	    /usr/share/varnish-agent/html.</p>
	    <p>VCL is typically stored to /usr/local/var/varnish-agent/ or
	    /usr/share/varnish-agent/, but check 
	    <a href="/help/vcl">/help/vcl</a> for the absolute
	    reference.</p>
	  </div>
	</div>
      </div><!--/row-->
    </div><!--/.fluid-container-->
</div>

    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="/html/jquery.js"></script>
    <script src="/html/bootstrap/js/bootstrap.js"></script>

    <script type="text/javascript">
	var out;
    	function vcl_load(vcl, id) {
		var client = new XMLHttpRequest();
		try {
		client.open("PUT", "/vcl/" + id, false);
		client.send(vcl);
		out = client.responseText;
		} catch (err) {
			out = "Com. errors with agent: \n" + err;
		}
		if (client.status == 201) {
			return true;
		} else {
			return false;
		}
	}
	function out_clear() {
		document.getElementById("out").innerHTML = "";
		out = "";
	}
	function out_up() {
		document.getElementById("out").innerHTML = out;
	}

	function vcl_show(id) {
		var client = new XMLHttpRequest();
		try {
		client.open("GET", "/vcl/" + id, false);
		client.send();
		} catch(err) {
		out = "Com. errors with agent: \n" + err;
		return null;
		}
		if (client.status == 200) {
			return client.responseText;
		} else {
			out = client.responseText;
			return null;
		}
	}
	function topActive(head) {
		var navs = new Array('nav-home', 'nav-vcl', 'nav-param');

		for (x in navs) {
			document.getElementById(navs[x]).className = "";
		}
		document.getElementById("nav-" + head).className = "active";
	}

	function showVCL() {
		document.getElementById("params").style.display = "NONE";
		document.getElementById("home").style.display = "NONE";
		document.getElementById("vcl").style.display = "block";
		topActive("vcl");
	}
	function showHome() {
		document.getElementById("params").style.display = "NONE";
		document.getElementById("home").style.display = "block";
		document.getElementById("vcl").style.display = "NONE";
		topActive("home");
	}
	function showParam() {
		document.getElementById("vcl").style.display = "NONE";
		document.getElementById("home").style.display = "NONE";
		document.getElementById("params").style.display = "block";
		list_params();
		topActive("param");
	}


	var setstate = false;
	function reset_status() {
		but = document.getElementById("status-btn");
		try {
		var client = new XMLHttpRequest();
		client.open("GET", "/status", false);
		client.send();
		stat = client.responseText;
		} catch (err) {
		stat = "Error communicating with agent: " + err;
		}
		but.textContent = stat;
		if (stat == "Child in state running") {
			but.className = "btn btn-primary btn-block disabled";
		} else {
			but.className = "btn btn-danger btn-block disabled";
		}
		setstate = false;
	}	
	function show_status(state,message) {
		setstate = true;
		but = document.getElementById("status-btn");
		if (state == "ok")
			but.className = "btn btn-success btn-block disabled";
		if (state == "warn")
			but.className = "btn btn-warning btn-block disabled";
		if (state == "error")
			but.className = "btn btn-danger btn-block disabled";
		but.textContent = message;
		setTimeout(function() { reset_status(); }, 3000);
	}

	function uploadVCL() {
		out_clear();
		var client = new XMLHttpRequest();
		ret = vcl_load(document.getElementById("vcl-text").value, document.getElementById("vclID").value);
		out_up();
		if (ret) {
			show_status("ok","VCL stored");
		} else {
			show_status("warn", "VCL save failed");
		}
	}

	function loadVCL() {
		out_clear();
		ret = vcl_show(document.getElementById("loader").value);
		if (ret == null)
			show_status("warn","VCL load failed");
		else
			show_status("ok", "VCL loaded");
		document.getElementById("vcl-text").value = ret;
		document.getElementById("vclID").value = document.getElementById("loader").value;
		out_up();
	}
	function listVCL() {
		var client = new XMLHttpRequest();
		client.open("GET", "/vcljson/", false);
		try {
		client.send();
		var vcllist = JSON.parse(client.responseText);
		if (client.responseText == vcl)
			return;
		vcl = client.responseText;
		var txt = "";
		var d = document.getElementById("loader");
		var active = "";
		for (x in vcllist["vcls"]) {
			v = vcllist["vcls"][x];
			if (v.status == "discarded") {
				continue;
			}
			if (v.status == "active") {
				active = v.name;
				document.getElementById("vcl-btn").innerHTML = "Active VCL: " + v.name;
			}
			txt = txt + "\n" + "<option>" + v.name + "</option>";
		}
		var d = document.getElementById("loader");
		d.innerHTML = txt;
		if (document.getElementById("vcl-text").value == "") {
			d.value = active;
			document.getElementById("vclID").value = active;
			loadVCL();
		}
		} catch (err) {
			out = "... failed.";
		}
	}

	var paramlist;

	function list_params() {
		try {
		var client = new XMLHttpRequest();
		client.open("GET", "/paramjson/", false);
		client.send();
		if (client.status != 200)
			throw new Error("Varnish-Agent returned " +
			client.status + ":" + client.responseText);
		paramlist = JSON.parse(client.responseText);
		var list = document.getElementById("param-sel");
		var v = list.value;
		var arry = new Array();
		for (x in paramlist) {
			arry.push(x);
		}
		arry.sort();
		list.options.length = 0;
		for (x in arry) {
			list.add(new Option(arry[x]));
		}
		if (v)
			list.value = v;
		paramChange();
		} catch (err) {
			out_clear();
			out = "Error listing parameters.\n"
			out = out + "Communication error with agent: \n"
			out = out + err;
			out_up();
		}

		return paramlist;
	}

	function paramChange() {
		var pname = document.getElementById("param-sel").value;
		document.getElementById("param-val").value = paramlist[pname].value;
		out_clear();
		out = "Default: " + paramlist[pname].default + "\n";
		out = out + "Value:   " + paramlist[pname].value + "\n";
		out = out + "Unit:    " + paramlist[pname].unit + "\n";
		out = out + paramlist[pname].description;
		out_up();
	}
	function paramListDiff() {
		out_clear();
		out = "Non-default parameters:\n\n"
		for (x in paramlist) {
			if (paramlist[x].unit == "seconds" || paramlist[x].unit == "s" || paramlist[x].unit == "bitmap") {
				one = Number(paramlist[x].value);
				two = Number(paramlist[x].default);
				if (one != two) {
					out = out + x + "(";
					out = out + one + " vs ";
					out = out + two + ")\n";
				}
			} else if (paramlist[x].unit == "bytes") {
				one = paramlist[x].value == "-1" ? "unlimited" : paramlist[x].value;
				two = paramlist[x].default == "-1" ? "unlimited" : paramlist[x].default;
				if (one != two) {
					out = out + x + "(";
					out = out + one + " vs ";
					out = out + two + ")\n";
				}

			} else if (paramlist[x].value != paramlist[x].default) {
				out = out + x + "(";
				out = out + paramlist[x].value + " vs ";
				out = out + paramlist[x].default + ")\n";
			}
		}
		out_up();
	}
	function saveParam()
	{
		var pname = document.getElementById("param-sel").value;
		var pval = document.getElementById("param-val").value;
		var client = new XMLHttpRequest();
		out_clear();
		client.open("PUT", "/param/" + pname, false);
		client.send(pval);
		out = client.responseText;
		out_up();
		if (client.status == 200) {
			show_status("ok","Parameter saved");
			list_params();
		} else {
			show_status("warn","Couldn't save parameter");
		}
	}
	function setParamDef()
	{
		var pname = document.getElementById("param-sel").value;
		var pval = document.getElementById("param-val");
		pval.value = paramlist[pname].default;
	}
	function vcl_use(id) {
		var client = new XMLHttpRequest();
		try {
		client.open("PUT", "/vcldeploy/" + id, false);
		client.send();
		out = client.responseText;
		} catch (err) {
		out = "Com. errors with agent: \n" + err;
		return false;
		}
		if (client.status = "200") {
			return true;
		} else {
			return false;
		}
	}
	function deployVCL() {
		out_clear();
		id = document.getElementById("loader").value;
		doc = vcl_use(id);
		if (doc) {
			show_status("ok","VCL deployed");
		} else {
			show_status("warn","vcl deploy failed");
		}
		out_up();	
	}
	function clearID() {
		document.getElementById("vclID").value = "";
	}
	function vcl_discard(id) {
		try {
		var client = new XMLHttpRequest();
		client.open("DELETE", "/vcl/" + id, false);
		client.send();
		out = client.responseText;
		} catch (err) {
		out = "Com. errors with agent: \n" + err;
		return false;
		}
		if (client.status = "200" && client.responseText == "") {
			return true;
		} else {
			return false;
		}
	}
	function discardVCL() {
		out_clear();
		doc = vcl_discard(document.getElementById("loader").value);
		if (doc) {
			show_status("ok","VCL discarded");
		} else {
			show_status("warn","VCL discard failed");
		}
		out_up();	
	}
	function stop() {
		var client = new XMLHttpRequest();
		client.open("PUT", "/stop", false);
		client.send();
		doc = client.responseText;
		document.getElementById("out").innerHTML = doc;
		status();
	}
	function start() {
		var client = new XMLHttpRequest();
		client.open("PUT", "/start", false);
		client.send();
		doc = client.responseText;
		document.getElementById("out").innerHTML = doc;
		status();
	}
	function status() {
		var client = new XMLHttpRequest();
		try {
		listVCL();
		} catch (err) {
		}
		if (!setstate)
			reset_status();
	}
	var stats = new Array();
	function update_stats() {
		var client = new XMLHttpRequest();
		var d = document.getElementById("stats-btn");
		try {
		client.open("GET","/stats", false);
		client.send();
		for (i = 0; i < 3; i++) {
			stats[i] = stats[i+1];
		}
		stats[3] = JSON.parse(client.responseText);
		var n_req = 0;
		var n_n_req = 0;
		for (i = 3; stats[i-1] != null; i--) {
			if (stats[i] == null) 
				break;
			if (stats[i].client_req == null)
				break;
			if (stats[i-1] != null && stats[i-1].client_req != null)
				n_req += stats[i].client_req.value - stats[i-1].client_req.value;
			else
				n_req += stats[i].client_req.value;
			n_n_req++;
		}
		if (n_n_req>0)
			d.innerHTML = Number(n_req/n_n_req).toFixed(0) + "req/s\n";
		} catch (err) {
			d.innerHTML = "Couldn't get stats";
		}

	}
	$('.btn').button();
	setInterval(function(){status()},10000);
	setInterval(function(){update_stats()},1000);
	listVCL();
    </script>
  </body>
</html>
